services:
  server:
    build:
      context: .
      dockerfile: Dockerfile.benchmark
    image: vidur-profiling:latest
    container_name: vidur-benchmark-server
    # Use host networking so it binds to localhost:8000 on the host
    network_mode: "host"
    environment:
      - HUGGING_FACE_HUB_TOKEN=${HF_TOKEN}
    volumes:
      - .:/app/vidur
      - ~/.cache/huggingface:/root/.cache/huggingface
      - ~/.cache/vllm:/root/.cache/vllm
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: python3 benchmark_server.py

  client:
    build:
      context: .
      dockerfile: Dockerfile.benchmark
    image: vidur-profiling:latest
    container_name: vidur-benchmark-client
    # Use host networking to access the server on localhost:8000
    network_mode: "host"
    volumes:
      - .:/app/vidur
    environment:
      # Since we are on host network, localhost works
      - VLLM_BASE_URL=http://localhost:8000/v1
    depends_on:
      - server
    command: python3 benchmark_client.py
