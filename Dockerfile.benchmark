FROM nvcr.io/nvidia/vllm:25.11-py3 AS vidur-benchmarking

# Install Python dependencies required by the benchmark notebook
RUN pip install --no-cache-dir \
    pandas \
    numpy \
    matplotlib \
    requests \
    nest_asyncio \
    jupyterlab \
    scipy \
    ray[default] \
    wandb \
    kaleido \
    plotly \
    seaborn \
    fasteners \
    pyyaml \
    tqdm

# Set the working directory
WORKDIR /app

# Expose ports for Jupyter (8888) and vLLM (8000)
EXPOSE 8888 8000

# Start Jupyter Lab
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", "--NotebookApp.token='1'", "--NotebookApp.password=''1"]

FROM vidur-benchmarking AS vidur-profiling

RUN git clone --branch vidur https://github.com/zivbeker42/sarathi-serve.git
RUN cd sarathi-serve/

RUN apt update 
RUN apt install -y nvidia-cuda-toolkit 
RUN pip uninstall -y torch torchvision
RUN pip install torch torchvision --index-url https://download.pytorch.org/whl/cu130
RUN rm -rf sarathi-serve
RUN git clone --branch vidur https://github.com/zivbeker42/sarathi-serve.git
WORKDIR /app/sarathi-serve

ENV TORCH_CUDA_ARCH_LIST="8.0 8.6 9.0"
RUN pip install --no-build-isolation . 

WORKDIR /app/vidur